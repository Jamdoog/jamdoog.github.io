<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Securing SSH with a Jump Host and Wireguard" /><meta property="og:locale" content="en" /><meta name="description" content="Reduce the attack surface of SSH by limiting it to a VPN only." /><meta property="og:description" content="Reduce the attack surface of SSH by limiting it to a VPN only." /><link rel="canonical" href="https://jamdoog.github.io/posts/securing-ssh-with-a-jump-host/" /><meta property="og:url" content="https://jamdoog.github.io/posts/securing-ssh-with-a-jump-host/" /><meta property="og:site_name" content="James Ledger Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-17T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Securing SSH with a Jump Host and Wireguard" /><meta name="twitter:site" content="@Jamdoog" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-18T13:27:33+00:00","datePublished":"2021-08-17T00:00:00+01:00","description":"Reduce the attack surface of SSH by limiting it to a VPN only.","headline":"Securing SSH with a Jump Host and Wireguard","mainEntityOfPage":{"@type":"WebPage","@id":"https://jamdoog.github.io/posts/securing-ssh-with-a-jump-host/"},"url":"https://jamdoog.github.io/posts/securing-ssh-with-a-jump-host/"}</script><title>Securing SSH with a Jump Host and Wireguard | James Ledger Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="James Ledger Blog"><meta name="application-name" content="James Ledger Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/13838902?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">James Ledger Blog</a></div><div class="site-subtitle font-italic">NIX, Virtualization & Networking</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Jamdoog" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Jamdoog" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['blog','jamdoog.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Securing SSH with a Jump Host and Wireguard</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Securing SSH with a Jump Host and Wireguard</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1629154800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 17, 2021 </em> </span> <span> Updated <em class="" data-ts="1679146053" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 18, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/Jamdoog">James</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1833 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h3 id="disclaimer-at-the-time-of-writing-this-wireguard-is-not-in-stable-repositories-of-some-distribution-"><span class="mr-2">*Disclaimer: At the time of writing this, Wireguard is not in stable repositories of some distribution. *</span><a href="#disclaimer-at-the-time-of-writing-this-wireguard-is-not-in-stable-repositories-of-some-distribution-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><hr /><p><em>**Secure Shell (SSH) **</em>is a useful utility which allows administrators to remotely control a plethora of devices ranging from routers to UNIX servers without exposing credentials in plaintext. Today, the majority of LINUX and UNIX based systems run a implementation of SSH called OpenSSH. Developed by the talented people over at the <a href="https://www.openbsd.org/">OpenBSD project</a>, their implementation of SSH is completely <a href="https://github.com/openssh">opensource</a> and free to the public.</p><p>On the contrary, <strong>Wireguard</strong> is a recently released communication protocol which is incredibly lightweight and simple. By working with purely key-based authentication, we can deploy hosts within seconds without any hassle of port forwarding on the client. As a result of this, people stuck behind a CG-NET deployment or even an IPv6 only network can tunnel without being concerned with opening ports.</p><p>By combining the two technologies, we can create a <strong><a href="https://en.wikipedia.org/wiki/Virtual_private_network">Virtual Private Network (VPN)</a></strong> by which the SSH service is exposed on, but not the WAN. By doing this, it drastically reduces the attack surface of SSH. I suspect this way of authentication is more useful for high security zones such as a co-location facility, however, there’s no harm in securing your own infrastructure… right?</p><hr /><h2 id="outlining-how-a-jump-host-functions"><span class="mr-2">Outlining <em>how</em> a Jump host functions</span><a href="#outlining-how-a-jump-host-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/assets/images/ssh-vpn/7232C832-C6E1-4E4C-85F3-ADAFE7BD2C62.gif" alt="A animation depicting traffic going through the jumper node then to the destination node and back" data-proofer-ignore>SSH utilises the jumper node as a intermediary for traffic A jump host will act as a intermediary between yourself and the target machine. You may jump more then once, but in this example there will only be 1 added hop. Ordinarily the user would not be able to access the nodes, however, by utilizing the Jump node as a intermediary we can then SSH into a node on the VPN.</p><hr /><h2 id="installing-wireguard"><span class="mr-2">Installing Wireguard</span><a href="#installing-wireguard" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the release of Wireguard into the Linux kernel 5.6, I would like to consider it a stable piece of software. In fact, with the addition of it in stable distributions such as Debian 11 it may even be classed as so. However, common stable distributions may lack behind the new 5.10 LTS kernel which means an equivalent of back ports has to be used.</p><h3 id="debian-11-bullseye"><span class="mr-2">Debian 11 ‘Bullseye’</span><a href="#debian-11-bullseye" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As mentioned, Debian 11 runs the latest 5.10 LTS kernel which means it has native support for Wireguard. As such, installing it is simple:</p><p><code class="language-plaintext highlighter-rouge">sudo apt install wireguard</code> <img data-src="/assets/images/ssh-vpn/deb11installl.png" alt="An image of the output from wireguard install" data-proofer-ignore></p><h3 id="debian-10-buster"><span class="mr-2">Debian 10 ‘Buster’</span><a href="#debian-10-buster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A little more complex, requires us to install the back ports repository and Linux headers. To do this, we must create a entry in <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list.d</code> containing the repository.</p><p><code class="language-plaintext highlighter-rouge">echo "deb http://deb.debian.org/debian buster-backports main" | sudo tee /etc/apt/sources.list.d/backports.list</code></p><p>Then we need to update our information for package sources:</p><p><code class="language-plaintext highlighter-rouge">sudo apt update</code></p><p>And finally followed by the install.</p><p><code class="language-plaintext highlighter-rouge">sudo apt install wireguard linux-headers-$(uname -r)</code></p><p>When I was installing this on some of my routers, I noticed that I could not find the correct linux-headers package. In my case, this was because I had previously updated my kernel <a href="https://www.youtube.com/watch?v=DPqdyoTpyEs">without rebooting</a>. <img data-src="/assets/images/ssh-vpn/deb10install.png" alt="An image of the output of the above commands" data-proofer-ignore></p><h2 id="rocky-linux-84-green-obsidian"><span class="mr-2">Rocky Linux 8.4 ‘Green Obsidian’</span><a href="#rocky-linux-84-green-obsidian" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Similar to Debian 10, Wireguard is not present in the base repository list nor Linux kernel until a new release comes out on the 5.10 LTS kernel. So for now, we must install both the <code class="language-plaintext highlighter-rouge">epel-release</code> and <code class="language-plaintext highlighter-rouge">elrepo-release</code> repositories.</p><p><code class="language-plaintext highlighter-rouge">sudo dnf install epel-release elrepo-release</code></p><p>I was happy to read that the epel-release repository was maintained by the Fedora team. However, the elrepo repository appears to be entirely third party.</p><p>Next, we just have to install the packages:</p><p><code class="language-plaintext highlighter-rouge">sudo dnf install kmod-wireguard wireguard-tools</code> <img data-src="/assets/images/ssh-vpn/rockyinstall.png" alt="An image of the above commands" data-proofer-ignore></p><h3 id="ubuntu-server-2004-lts-focal-fossa"><span class="mr-2">Ubuntu Server 20.04 LTS ‘Focal Fossa’</span><a href="#ubuntu-server-2004-lts-focal-fossa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>While I’m not an Ubuntu person, I am sometimes jealous of the up to date package repositories… Similar to Debian 11, we just have to install the <code class="language-plaintext highlighter-rouge">wireguard</code> package.</p><p><code class="language-plaintext highlighter-rouge">sudo apt install wireguard</code> <img data-src="/assets/images/ssh-vpn/ubuntuinstall.png" alt="An image of the above command" data-proofer-ignore> —</p><h2 id="configuring-wireguard"><span class="mr-2">Configuring Wireguard</span><a href="#configuring-wireguard" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Wireguard uses a public key authentication system. This means that each side of the tunnel has a store of keys to encrypt traffic with that only the correct peer may decrypt. <img data-src="/assets/images/ssh-vpn/10813180-DAE1-472F-BFBA-14AF8A0FA908.gif" alt="A animation depicting public key authentication" data-proofer-ignore>Each peer communicate in a secure manner by encrypting it’s traffic with the peer’s public key Comical drawing aside, the above illustration displays a abstracted view of the transaction. Do not that this transaction will happen on both sides, it is not a client-server model.</p><p>On both the Jumper and the endpoint, we need to generate a private key. This will create a public key based off it which we will need to take note of. This can be accomplished with the command:</p><p><code class="language-plaintext highlighter-rouge">wg genkey</code> <img data-src="/assets/images/ssh-vpn/wggenkey.png" alt="" data-proofer-ignore> You’ll need to do this command twice, and take note of the keys generated.</p><p>Once we have the keys, we can go ahead and configure our Wireguard configuration files. By default, Wireguard will read from the <code class="language-plaintext highlighter-rouge">/etc/wireguard</code> directory. In here, we want to create a file called <code class="language-plaintext highlighter-rouge">wg0.conf</code> and configure our tunnel.</p><p><code class="language-plaintext highlighter-rouge">sudo nano /etc/wireguard/wg0.conf</code></p><h3 id="jumper"><span class="mr-2">Jumper</span><a href="#jumper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Some things to note about the configuration of Wireguard is that it fully supports dual stack networking. As such, not only can your VPN have IPv6 but it can also tunnel over IPv6! Just ensure you encapsulate the <code class="language-plaintext highlighter-rouge">endpoint</code> variable in <code class="language-plaintext highlighter-rouge">[]</code> if you plan to use IPv6. In anycase, here is my configuration file:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>[Interface]
PrivateKey = 4IUXksWM2WyPWr3jAmmbRDxLNdDTDKTiOfIr1pLhaEg=
Address = 10.40.0.1/24
ListenPort = 12342
</pre></table></code></div></div><p>Example configuration file Then we can bring up the interface and view the public key it created. We will need to note this down as it’s required for our endpoint to encrypt traffic with.</p><p><code class="language-plaintext highlighter-rouge">wg-quick up wg0</code></p><p>We can see that we received a basic verbose output stating what commands have been executed: <img data-src="/assets/images/ssh-vpn/wgquickup1-1.png" alt="An image depicting an interface being created with the name 'wg0' and appropriate configurations to said interface" data-proofer-ignore>It will execute commands for us to create the interface Now we can retreive the public key of this configuration file. Actually, the command will show us more information then this but as of right now it’s only useful for this,</p><p><code class="language-plaintext highlighter-rouge">sudo wg show</code> <img data-src="/assets/images/ssh-vpn/wgshow1-1.png" alt="The above commands output" data-proofer-ignore>The command will output the public key and other helpful information Once we have this public key, we are ready to configure the endpoint.</p><h3 id="endpoint"><span class="mr-2">Endpoint</span><a href="#endpoint" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Similar to before, we need to edit <code class="language-plaintext highlighter-rouge">/etc/wireguard/wg0.conf</code> but this time we have the addition of a peer notation thanks to the public key we generated above.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>[Interface]
PrivateKey = 0HGqP0XNeXz3AWOniHwkNeBXQIsMiajiHl5+5uyBilA=
Address = 10.40.0.2/24
ListenPort = 12342

[Peer]
PublicKey = wiPoP3ybHBP+h7kfvO3r9vbRT9DON3W5FWbDlLAfb3E=
AllowedIPs = 10.40.0.1/32
Endpoint = 10.10.69.54:12342
PersistentKeepalive = 20
</pre></table></code></div></div><p>Example configuration file in addition to peer After bringing up the interface, we can see not only the interface configuration but a peer configuration! <img data-src="/assets/images/ssh-vpn/end1up.png" alt="The result of creating our wireguard config file with the peer notation added" data-proofer-ignore>Full configuration for the endpoint Once more, we need to log the public key and adjust our Jump config.</p><h3 id="jumper-1"><span class="mr-2">Jumper</span><a href="#jumper-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Go ahead and replicate the peer configuration we created on the endpoint, exchanging the appropriate variables:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>[Interface]
PrivateKey = 4IUXksWM2WyPWr3jAmmbRDxLNdDTDKTiOfIr1pLhaEg=
Address = 10.40.0.1/24
ListenPort = 12342

[Peer]
PublicKey = zQerI54YmapcmodE+OpZSumMe0GknZPlVC3KHXT0I2o=
AllowedIPs = 10.40.0.2/32
Endpoint = 10.10.69.30:12342
PersistentKeepalive = 20
</pre></table></code></div></div><p>However, we can’t “up” and already active interface so we must down it then up it to make the changes take effect.</p><p><code class="language-plaintext highlighter-rouge">wg-quick down wg0 &amp;&amp; wg-quick up wg0</code> <img data-src="/assets/images/ssh-vpn/donewgconfig.png" alt="An image of 'wg show' depicting an active tunnel between the two peers" data-proofer-ignore>Active Wireguard Tunnel! Just like that, we have a connection between the two hosts that is lightweight and encrypted. We can verify it by pinging one of the IP’s inside the tunnel: <img data-src="/assets/images/ssh-vpn/pingwgtunnel.png" alt="" data-proofer-ignore>We can reach the endpoint’s IP —</p><h2 id="securing-ssh"><span class="mr-2">Securing SSH</span><a href="#securing-ssh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Creating the tunnels between the Jumper and the endpoint is only part of the configuration. The other part of it is securing SSH on the endpoint. More specifically, putting in the line <code class="language-plaintext highlighter-rouge">ListenAddress &lt;ip&gt;</code></p><p>This config option will make the OpenSSH server listen on the IP specified and no others. You can have multiple entries for this option for example if you want to add some redundancy to this setup.</p><p>There are also other options which may prove useful in the config. For example, disabling root SSH login or changing the port. Here is my list of options.</p><p>Debian: <code class="language-plaintext highlighter-rouge">nano /etc/ssh/sshd_config</code></p><p>Rocky/RHEL: <code class="language-plaintext highlighter-rouge">nano /var/lib/systemd/system/sshd.service</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>ListenAddress 192.168.174.11
ListenAddress 192.168.53.5
ListenAddress 10.40.0.2
Port 7184
PermitRootLogin no
PubkeyAuthentication yes
AuthorizedKeysFile	.ssh/authorized_keys .ssh/authorized_keys2
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM no
X11Forwarding yes
AcceptEnv LANG LC_*
</pre></table></code></div></div><p>There are also other options you can do such as disabling TTY outright and forcing <code class="language-plaintext highlighter-rouge">/sbin/nologin</code> however I do not force this at the moment.</p><hr /><h2 id="how-to-connect"><span class="mr-2">How to connect</span><a href="#how-to-connect" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Connecting to one of your boxes through the Jumper can be accomplished multiple ways. The easiest way is to store the SSH data in <code class="language-plaintext highlighter-rouge">~/.ssh/config</code>. This file follows a specific syntax to outline hosts and other miscellaneous SSH details such as host names and port numbers. Alternatively, you can use arguments in the SSH command itself to dictate where to hop to and from.</p><h3 id="ssh-config"><span class="mr-2">SSH Config</span><a href="#ssh-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The SSH config file can hold traits for each individual connection or wildcard traits. For example, if all your services use port 7184 for SSH, you could deploy this. I would advise reading <a href="https://linux.die.net/man/5/ssh_config">the man page</a> to learn more.</p><p><code class="language-plaintext highlighter-rouge">nano ~/.ssh/config</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>Host Jump
        User jumper
        Hostname 192.168.53.1

Host Mail
        User mail
        Hostname 192.168.53.5
        ProxyJump Jump

Host Mailbackup
        User mail
        Hostname 192.168.53.6
        ProxyJump Jump

Host NS1
        User dns
        Hostname 192.168.53.7
        ProxyJump Jump

Host * 
        Port 7184
</pre></table></code></div></div><p>After creating this file, you can connect to each host via typing:</p><p><code class="language-plaintext highlighter-rouge">ssh &lt;name&gt;</code></p><p>For example, connecting to my NS1 would be:</p><p><code class="language-plaintext highlighter-rouge">ssh NS1</code></p><h3 id="ssh-parameters"><span class="mr-2">SSH Parameters</span><a href="#ssh-parameters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you do not want to create a manual configuration file, you can replicate this inline with the SSH command. Similar to the above, if you wanted to SSH to the NS1 server we would do the following:</p><p><code class="language-plaintext highlighter-rouge">ssh -J jumper@192.168.53.1 -p 7184 dns@192.168.53.7 -p 7184</code></p><p>The syntax of it of course being:</p><p><code class="language-plaintext highlighter-rouge">ssh -J &lt;user&gt;@&lt;jumper_ip&gt; &lt;user&gt;@&lt;endpoint_vpn_ip&gt;</code></p><h2 id="confirmation"><span class="mr-2">Confirmation</span><a href="#confirmation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After configuring this all, we can verify that not only is it going via the SSH tunnel but also that SSH is not listening on any public interfaces.</p><h3 id="going-through-the-vpn"><span class="mr-2">Going through the VPN</span><a href="#going-through-the-vpn" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If we check <code class="language-plaintext highlighter-rouge">/var/log/auth.log</code> (or <code class="language-plaintext highlighter-rouge">/var/log/secure</code> on RHEL) we can see that SSH sessions have been established via our tunnel address, more specifically the jumper address:</p><p><code class="language-plaintext highlighter-rouge">Aug 17 21:07:16 hostname sshd[6296]: Accepted publickey for root from 192.168.53.1 port 1234 ssh2: RSA SHA256:ABCdefg...</code></p><p><code class="language-plaintext highlighter-rouge">Aug 17 15:07:46 hostname sshd[1343532]: Accepted publickey for root from 192.168.53.1 port 1234 ssh2: RSA SHA256:ABCdefg...</code></p><p>Another quick way to verify this is by using the <code class="language-plaintext highlighter-rouge">w</code> command:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> 21:11:12 up 6 days, 20:46,  3 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
dns      pts/0    192.168.53.1     21:07    0.00s  0.00s  0.00s w
</pre></table></code></div></div><h3 id="verifying-ssh-only-listens-on-the-vpn-address"><span class="mr-2">Verifying SSH only listens on the VPN address</span><a href="#verifying-ssh-only-listens-on-the-vpn-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>There are multiple ways to see what net connections are active on a Linux host. The one I always remember is <code class="language-plaintext highlighter-rouge">netstat -tulpn</code>. Paired with a <code class="language-plaintext highlighter-rouge">grep</code> command, we can filter it to specifically show only the SSH service:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>root@hostname:~# netstat -tulpn | grep 7184           
tcp        0      0 10.40.0.2:7184          0.0.0.0:*               LISTEN      2448/sshd
</pre></table></code></div></div><p>As we can see in the above snippet, it is only binding to the address <code class="language-plaintext highlighter-rouge">10.40.0.2</code> as opposed to <code class="language-plaintext highlighter-rouge">0.0.0.0</code>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a> <a href="/tags/networking/" class="post-tag no-text-decoration" >Networking</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Securing+SSH+with+a+Jump+Host+and+Wireguard+-+James+Ledger+Blog&url=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fsecuring-ssh-with-a-jump-host%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Securing+SSH+with+a+Jump+Host+and+Wireguard+-+James+Ledger+Blog&u=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fsecuring-ssh-with-a-jump-host%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fsecuring-ssh-with-a-jump-host%2F&text=Securing+SSH+with+a+Jump+Host+and+Wireguard+-+James+Ledger+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/configuring-freeipa-ldap-with-ansible-automation-platform-25/">Configuring FreeIPA LDAP with Ansible Automation Platform 2.5</a><li><a href="/posts/deploying-a-cdn-with-geodns/">Deploying a "CDN" with GeoDNS</a><li><a href="/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/">Managing edge nodes with Docker and GitLab</a><li><a href="/posts/jtag-install/">JTAG Hacking a Xbox 360 in 2021</a><li><a href="/posts/securing-ssh-with-a-jump-host/">Securing SSH with a Jump Host and Wireguard</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux,</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/ansible/">Ansible,</a> <a class="post-tag" href="/tags/container/">Container,</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/docker/">Docker,</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/free60/">free60</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/scaleway-s3-stardust/"><div class="card-body"> <em class="small" data-ts="1632956400" data-df="ll" > Sep 30, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Taking advantage of free S3 compatible storage on a £0.30 VPS</h3><div class="text-muted small"><p> This post is not meant to be used in a production workflow. I just wanted to show how you can host some data for practically free while being under your OWN terms I have a problem with renting...</p></div></div></a></div><div class="card"> <a href="/posts/guest-agent-on-pfsense/"><div class="card-body"> <em class="small" data-ts="1653519600" data-df="ll" > May 26, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>QEMU Guest Agent on pfSense</h3><div class="text-muted small"><p> A piece of software I always found fascinating about hypervisors was the concept of a guest agent. The first example I recall was file sharing from a VMWare Host to Guest on Workstation which see...</p></div></div></a></div><div class="card"> <a href="/posts/configuring-freeipa-ldap-with-ansible-automation-platform-25/"><div class="card-body"> <em class="small" data-ts="1735603200" data-df="ll" > Dec 31, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring FreeIPA LDAP with Ansible Automation Platform 2.5</h3><div class="text-muted small"><p> Introduction This is a quick blog post to highlight integrating FreeIPA’s LDAP(S) into the recent Ansible Automation Platform 2.5. This also applies to RedHat’s Identity Management (IDM) which is...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/pfsense-sriov/" class="btn btn-outline-primary" prompt="Older"><p>pfSense Routing with SR-IOV and Proxmox</p></a> <a href="/posts/scaleway-s3-stardust/" class="btn btn-outline-primary" prompt="Newer"><p>Taking advantage of free S3 compatible storage on a £0.30 VPS</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/Jamdoog">James</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux,</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/ansible/">Ansible,</a> <a class="post-tag" href="/tags/container/">Container,</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/docker/">Docker,</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/free60/">free60</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
