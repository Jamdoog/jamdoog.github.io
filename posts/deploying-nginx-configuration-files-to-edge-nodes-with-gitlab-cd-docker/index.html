<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Managing edge nodes with Docker and GitLab" /><meta property="og:locale" content="en" /><meta name="description" content="This post is a continuation of my previous post, “Deploying a ‘CDN’ with GeoDNS”." /><meta property="og:description" content="This post is a continuation of my previous post, “Deploying a ‘CDN’ with GeoDNS”." /><link rel="canonical" href="https://jamdoog.github.io/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/" /><meta property="og:url" content="https://jamdoog.github.io/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/" /><meta property="og:site_name" content="James Ledger Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-30T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Managing edge nodes with Docker and GitLab" /><meta name="twitter:site" content="@Jamdoog" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-25T18:03:30+00:00","datePublished":"2020-12-30T00:00:00+00:00","description":"This post is a continuation of my previous post, “Deploying a ‘CDN’ with GeoDNS”.","headline":"Managing edge nodes with Docker and GitLab","mainEntityOfPage":{"@type":"WebPage","@id":"https://jamdoog.github.io/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/"},"url":"https://jamdoog.github.io/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/"}</script><title>Managing edge nodes with Docker and GitLab | James Ledger Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="James Ledger Blog"><meta name="application-name" content="James Ledger Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/13838902?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">James Ledger Blog</a></div><div class="site-subtitle font-italic">NIX, Virtualization & Networking</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Jamdoog" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Jamdoog" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['blog','jamdoog.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Managing edge nodes with Docker and GitLab</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Managing edge nodes with Docker and GitLab</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1609286400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 30, 2020 </em> </span> <span> Updated <em class="" data-ts="1700935410" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 25, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/Jamdoog">James</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1561 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p><a href="">This post is a continuation of my previous post, “Deploying a ‘CDN’ with GeoDNS”.</a></p><p><a href="">Reviewing this in 2023 - This is when I knew little about containers. Consider this a ‘test poc’ ;)</a></p><p>One of the many challenges I faced when creating my CDN was a method of updating the vHost configuration files among multiple PoP’s. At first I was manually creating and modifying the conf files on a base, none-containerised install of NGINX (CentOS 8). It dawned on me when working with a client from CubeOps to install Ghost in a container, that this would be the prefect time to finally get around to learning how to utilise docker for myself.</p><p>When researching how I should handle this, I realised that I had to learn how to create my own images and how to host them before deploying them. Hosting them at a service like Dockerhub does work, but there is a significantly less learning curve involved in that and giving out my data to GitHub is not a preferred method. Especially when it involves private keys…</p><p>The solution I settled on initially was hosting the registry and gitlab on the same machine in a separate container. Although I soon realised that GitLab had its own integration and container registry which would prove to make it significantly easier and less “hacky”.</p><p>Below is some of the steps I took to deploy this service:</p><hr /><p><strong>Base system requirements</strong></p><p>A server with the following criteria:</p><ul><li>At least 4GB of RAM<li>1 semi-powerful CPU core<li>At least 10GB of storage<li>A Linux distro of your choice (I chose Debian 10)<li>Container technology capabilities.</ul><p>I found that OpenVZ does not integrate well with containers by default unless the host specifically enables it. As such I recommend KVM.</p><h2 id="dns-records"><span class="mr-2"><strong>DNS records</strong></span><a href="#dns-records" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th style="text-align: center"> <th style="text-align: center"> <th style="text-align: center"> <th style="text-align: center"> <tbody><tr><td style="text-align: center">Name<td style="text-align: center">Type<td style="text-align: center">Value<td style="text-align: center">Required<tr><td style="text-align: center">gitlab<td style="text-align: center">A<td style="text-align: center">IP<td style="text-align: center">Yes<tr><td style="text-align: center">registry<td style="text-align: center">CNAME<td style="text-align: center">gitlab<td style="text-align: center">No</table></div><p>The registry sub domain is not required unless you do not want to connect to your registry via a remote port. We will expose the registry via HTTPS later on. Feel free to setup a reverse proxy for it.</p><hr /><h2 id="installing-gitlab-via-docker"><span class="mr-2">Installing GitLab (via Docker)</span><a href="#installing-gitlab-via-docker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Installing GitLab is not a challenging task thanks to the power of containers. In fact, the hardest part about it would actually be the decision of how you would like to store your data. For this I decided that it would be best to store my configuration files on the host under <strong>/srv/gitlab</strong>.</p><p>docker run –detach</p><p>–hostname gitlab.example.com</p><p>–publish 443:443 –publish 80:80 –publish 5050:5050 –publish 5050:5050</p><p>–name gitlab</p><p>–restart always</p><p>–volume /srv/gitlab/config:/etc/gitlab</p><p>–volume /srv/gitlab/logs:/var/log/gitlab</p><p>–volume /srv/gitlab/data:/var/opt/gitlab</p><p>–env GITLAB_OMNIBUS_CONFIG=”external_url ‘<a href="https://gitlab.example.com/">https://gitlab.example.com/</a>’;”</p><p>gitlab/gitlab-ce:latest</p><p>The above command will automatically pull and run a gitlab community edition image**. **If you want to deploy the enterprise edition, change it to gitlab-ee:latest. It will then allow the container to bind to the ports 80, 443, 5050 &amp; 5555 which is all required. Next, it sets the omnibus variable within GitLab for our URL to <a href="https://gitlab.example.com/"><strong>https://gitlab.example.com</strong></a>. This variable will automatically deploy a LetsEncrypt certificate if there is HTTPS present at the start which we will utilise later on. Finally, we will name the container “gitlab” and make sure it automatically starts when the Docker daemon is loaded.</p><p>You can check the logs of this container by doing:</p><p>docker logs gitlab</p><p>GitLab should now be live at <a href="https://gitlab.example.com/">https://gitlab.example.com</a> and accessible over HTTPS. After setting up a root password, you can login and be presented with your personal projects.</p><p>We will be utilising the admin page which can be accessed by the wrench on the top taskbar. This is so that we can setup a GitLab runner which will be used for building the dockerfiles</p><p><img data-src="/assets/images/nginx-edge-2020/gitlab-1.png" alt="A image depicting the landing page after GitLab sign in." data-proofer-ignore> <img data-src="/assets/images/nginx-edge-2020/gitlab_admin-1.png" alt="A image depicting the GitLab administrative panel page" data-proofer-ignore> —</p><h2 id="creating-a-gitlab-runner-via-docker"><span class="mr-2">Creating a GitLab runner (via Docker)</span><a href="#creating-a-gitlab-runner-via-docker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GitLab requires runners in order to compile and test your commits. In our case, they will test our dockerfile, NGINX vHost configurations and deploy to the edge nodes.</p><p>Setting this up proved to be difficult at first but after some researching I found that in order to make this work with docker we essentially have to deploy a “docker in docker” image which will pass through the hosts docker socket. In addition, we will need to make it a privileged runner otherwise it will not have the right permissions to run these tests. To begin with, head to the admin panel and then click runners.</p><p><img data-src="/assets/images/nginx-edge-2020/gitlab_admin_runner.png" alt="Image depicting the selection of the runner tab on GitLab" data-proofer-ignore></p><p>Runner tab on the left After this, you should be presented with options about adding a new runner. In this case, we want to copy the token that it provides. We should also note down the URL, which should be the same as your gitlab instance. <img data-src="/assets/images/nginx-edge-2020/gitlab_admin_runner_token-1.png" alt="Image depicting the setup of a GitLab runner via URL and Token" data-proofer-ignore> GitLab runner manual token Once we have this, head over to your Linux box and put in the following:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>docker run --rm -it -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register -n \

--url $GITLAB_URL \

--registration-token $REGISTRATION_TOKEN \

--executor docker \

--description "Docker Runner" \

--docker-image "docker:stable" \

--docker-privileged
</pre></table></code></div></div><p>This should then register the runner with your GitLab instance. However, we passed through the RM command which means it will exit after the command ends. To run the runner permanently, we need to once more run it.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>docker run -d --name gitlab-runner --restart always 

-v /srv/gitlab-runner/config:/etc/gitlab-runner 

-v /var/run/docker.sock:/var/run/docker.sock 

gitlab/gitlab-runner:latest
</pre></table></code></div></div><h2><img data-src="/assets/images/nginx-edge-2020/gitlab_runner_success.png" alt="Image depicting GitLab runner page with runner available for us" data-proofer-ignore></h2><h2 id="setting-up-a-container-registry-via-gitlab"><span class="mr-2">Setting up a Container Registry (Via GitLab)</span><a href="#setting-up-a-container-registry-via-gitlab" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The container registry on GitLab is quite simple to setup. Earlier when we deployed GitLab we passed through the port 5050 &amp; 5555. This will be used for the container registry and a HTTP mirror of it.</p><p>To begin with, we will want to edit the file **/srv/gitlab/config/gitlab.rb **on the hostand find  the following lines:</p><p><code class="language-plaintext highlighter-rouge">registry_external_url</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['ssl_certificate']</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['ssl_certificate_key']</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['enable']</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['listen_port']</code></p><p>If you are unfamiliar with basic file editing principles, do the following. It will take you to the sections of the config where these are stored:</p><blockquote><p>nano /srv/gitlab/config/gitlab.rb</p></blockquote><blockquote><p>CTRL + W</p></blockquote><blockquote><p>registry_external_url</p></blockquote><blockquote><p>CTRL + W</p></blockquote><p><code class="language-plaintext highlighter-rouge">registry_nginx['enable']</code></p><p>We then want to edit these values to the following, replacing gitlab.example.com with your instance url.</p><p><code class="language-plaintext highlighter-rouge">registry_external_url</code> = ‘<a href="https://gitlab.example.com:5555">https://gitlab.example.com:5555</a>’</p><p><code class="language-plaintext highlighter-rouge">registry_nginx['ssl_certificate']</code> = <code class="language-plaintext highlighter-rouge">"/etc/letsencrypt/live/gitlab.example.com/fullchain.pem</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['ssl_certificate_key']</code> = <code class="language-plaintext highlighter-rouge">"/etc/letsencrypt/live/gitlab.example.com/privkey.pem</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['enable'] = true</code></p><p><code class="language-plaintext highlighter-rouge">registry_nginx['listen_port'] = 5050</code></p><p><img data-src="/assets/images/nginx-edge-2020/putty_nxaMPB6vk5.png" alt="" data-proofer-ignore><img data-src="/assets/images/nginx-edge-2020/registry_2.png" alt="" data-proofer-ignore><img data-src="/assets/images/nginx-edge-2020/registry_3.png" alt="" data-proofer-ignore></p><p><code class="language-plaintext highlighter-rouge">docker exec gitlab gitlab-ctl reconfigure</code></p><hr /><h2 id="creating-the-repository--gitlab-ci-instructions"><span class="mr-2">Creating the repository &amp; GitLab CI instructions</span><a href="#creating-the-repository--gitlab-ci-instructions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When deploying the app to my edge nodes it first needs to be built and tested. To begin with, I added my initial NGINX configuration files then created a Dockerfile and .gitlab_ci.yml file. <img data-src="/assets/images/nginx-edge-2020/cdn_files.png" alt="Image depicting the files in my CDN repository" data-proofer-ignore>All the files in my repository. Note: This is after my pushes. The way my ‘CDN’ works is it caches a web request from my origin server and serves it. The Dockerfile will grab a nginx:mainline-alpine image and copy the vHost files to the respective directories (~/conf.d/) and then copy the SSL configuration files to ~/live/. Finally, it will test the vHost files and then start NGINX.</p><div class="language-docker highlighter-rouge"><div class="code-header"> <span data-label-text="Docker"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> nginx:mainline-alpine</span>

<span class="k">RUN </span><span class="nb">rm</span> /etc/nginx/conf.d/default.conf

<span class="k">COPY</span><span class="s"> jamdoog.conf /etc/nginx/conf.d/jamdoog.conf</span>

<span class="k">COPY</span><span class="s"> blog.jamdoog.conf /etc/nginx/conf.d/blog.jamdoog.conf</span>

<span class="k">COPY</span><span class="s"> analytics.jamdoog.conf /etc/nginx/conf.d/analytics.jamdoog.conf</span>

<span class="k">COPY</span><span class="s"> fullchain.cer /etc/nginx/live/fullchain.cer</span>

<span class="k">COPY</span><span class="s"> jamdoog.com.key /etc/nginx/live/jamdoog.com.key</span>

<span class="k">COPY</span><span class="s"> options-ssl-nginx.conf /etc/nginx/live/options-ssl-nginx.conf</span>

<span class="k">COPY</span><span class="s"> ssl-dhparams.pem /etc/nginx/live/ssl-dhparams.pem</span>

<span class="k">COPY</span><span class="s"> nginx.conf /etc/nginx/nginx.conf</span>

<span class="k">RUN </span>nginx <span class="nt">-t</span>

<span class="k">EXPOSE</span><span class="s"> 443</span>

<span class="k">CMD</span><span class="s"> ["nginx", "-g", "daemon off;"]</span>
</pre></table></code></div></div><p>The gitlab CI file will do the following:</p><p>Pull the Docker-in-Docker image</p><p>Define the following stages:</p><ul><li>Build<li>Release<li>Deploy<li>Test</ul><p>Grab the dockerfiles and build the image</p><p>Deploy the image to the container registry</p><p>Run a script on each edge node to pull the latest dockerfile and deploy it</p><p>Curl each edge node to verify the page is working</p><p>I cannot share the file because it would compromise my security but there is alot of documentation available online on how to use Gitlab CI.</p><hr /><h2 id="evaluation"><span class="mr-2">Evaluation</span><a href="#evaluation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>My workflow with GitLab CD and my own container registry has created the ability to deploy changes to my edge nodes within a minute. Instead of spending 10 minutes modifying NGINX configuration files globally, all I have to do is commit a push to my GitLab server.</p><p>However, there is some minor problems with this approach. Docker is meant to be used for scalability and the way I have set this up does not attempt it properly. My original plan was to use Docker Swarm which while actually would have worked as intended, I wanted it to show the edge node at https://jamdoog.com as opposed to the master’s node. I decided I would then operate the edge nodes as independant docker masters.</p><p>Another problem with this approach is that when I deploy to my edge nodes, it is not as clean of an approach as I would like. However, in a production system I would adapt this to a method which should actually be used in production.</p><h2 id="what-i-would-change"><span class="mr-2">What I would change</span><a href="#what-i-would-change" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When doing this whole project over again, I would absolutely reconsider the whole topology of the ‘CDN’ and how data is served. As mentioned, caching the web server works but traditional CDN’s will store assets on fast disks or even RAM. It’s quite clear that this is a makeshift solution on a budget. When services such as BunnyCDN and Cloudflare exist, it’s impossible to recommend this unless it’s strictly for learning.</p><p>However, the GitLab workflow outlined in this post is great and it is not something I would change. Obviously it is not the intended use, but it has been a greater learning curve than a couple of rsync commands in loops.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux,</a> <a href="/tags/web/" class="post-tag no-text-decoration" >Web,</a> <a href="/tags/git/" class="post-tag no-text-decoration" >Git,</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker,</a> <a href="/tags/container/" class="post-tag no-text-decoration" >Container,</a> <a href="/tags/nginx/" class="post-tag no-text-decoration" >NGINX</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Managing+edge+nodes+with+Docker+and+GitLab+-+James+Ledger+Blog&url=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fdeploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Managing+edge+nodes+with+Docker+and+GitLab+-+James+Ledger+Blog&u=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fdeploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjamdoog.github.io%2Fposts%2Fdeploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker%2F&text=Managing+edge+nodes+with+Docker+and+GitLab+-+James+Ledger+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/configuring-freeipa-ldap-with-ansible-automation-platform-25/">Configuring FreeIPA LDAP with Ansible Automation Platform 2.5</a><li><a href="/posts/deploying-a-cdn-with-geodns/">Deploying a "CDN" with GeoDNS</a><li><a href="/posts/deploying-nginx-configuration-files-to-edge-nodes-with-gitlab-cd-docker/">Managing edge nodes with Docker and GitLab</a><li><a href="/posts/jtag-install/">JTAG Hacking a Xbox 360 in 2021</a><li><a href="/posts/securing-ssh-with-a-jump-host/">Securing SSH with a Jump Host and Wireguard</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux,</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/ansible/">Ansible,</a> <a class="post-tag" href="/tags/container/">Container,</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/docker/">Docker,</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/free60/">free60</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/deploying-a-cdn-with-geodns/"><div class="card-body"> <em class="small" data-ts="1608076800" data-df="ll" > Dec 16, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Deploying a "CDN" with GeoDNS</h3><div class="text-muted small"><p> Introduction When wondering how to pass the time I decided to optimise my website. I took initial steps such as minimising CSS and JS however incase you haven’t seen, my (old) base site actually i...</p></div></div></a></div><div class="card"> <a href="/posts/pfsense-sriov/"><div class="card-body"> <em class="small" data-ts="1625353200" data-df="ll" > Jul 4, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>pfSense Routing with SR-IOV and Proxmox</h3><div class="text-muted small"><p> Introduction Single Root I/O Virtualization (SR-IOV) is a technology that was developed in order to split up physical PCI devices into multiple separate PCI devices. In a virtualization stack, it ...</p></div></div></a></div><div class="card"> <a href="/posts/configuring-freeipa-ldap-with-ansible-automation-platform-25/"><div class="card-body"> <em class="small" data-ts="1735603200" data-df="ll" > Dec 31, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configuring FreeIPA LDAP with Ansible Automation Platform 2.5</h3><div class="text-muted small"><p> Introduction This is a quick blog post to highlight integrating FreeIPA’s LDAP(S) into the recent Ansible Automation Platform 2.5. This also applies to RedHat’s Identity Management (IDM) which is...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/deploying-a-cdn-with-geodns/" class="btn btn-outline-primary" prompt="Older"><p>Deploying a "CDN" with GeoDNS</p></a> <a href="/posts/jtag-install/" class="btn btn-outline-primary" prompt="Newer"><p>JTAG Hacking a Xbox 360 in 2021</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/Jamdoog">James</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux,</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/ansible/">Ansible,</a> <a class="post-tag" href="/tags/container/">Container,</a> <a class="post-tag" href="/tags/container/">Container</a> <a class="post-tag" href="/tags/docker/">Docker,</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/free60/">free60</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
